#!/usr/bin/env php
<?php
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å CLI ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
function isRunningFromCLI(): bool {
    return php_sapi_name() === 'cli' || defined('STDIN');
}
// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà CLI ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
if (!isRunningFromCLI()) {
    die("This script must be run from the command line.\n");
}

use Core\Database;
use Dotenv\Dotenv;

require_once __DIR__ . '/vendor/autoload.php';
$dotenv = Dotenv::createImmutable(__DIR__);
$dotenv->load();

// ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å command  ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
// Command : php deawx make:model cyberthai -v
// Array
// (
// [0] => deawx
// [1] => make:model
// [2] => cyberthai
// [3] => -v
// )
// $sh->dd($argv);
// print_r($argv);
// // echo "\033[41m \033[7m\033[1m ERROR!! \033[0m \033[41m Migration name is required.!! \033[0m\n";
// // echo "\033[42m \033[7m\033[1m Successfully!! \033[0m \033[45m Migration created : {$argv[1]} \033[0m\n";
// exit();
$command = $argv[1] ?? null;

// print_r($argv);
// print_r($command);

switch ($command) {
    case 'migrate':
        // migrate ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        migrate();
        break;
    case 'migrate:reset':
        // ‡∏•‡∏ö migrate ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        migratereset();
        break;
    case 'make:migration':
        $name = $argv[2] ?? null;
        makemigration($name);
        break;
    case 'make:controller':
        $name = $argv[2] ?? null;
        makecontroller($name);
        break;
    case 'make:model':
        // name model
        $name = $argv[2] ?? null;
        makemodel($name);
        break;
    case 'dump-autoload':
        dumpAutoload();
        break;
    case 'serve':
        serve();
        break;
    default:
        echo "\033[41m \033[7m\033[1m ERROR!! \033[0m \033[41m X:\Deawx> Command Not Found.!! \033[0m\n";
        // echo "\033[41m \033[7m X:\Deawx> Command Not Found.!! \033[0m\n";
        break;
}

function migrate() {
    try {
        // Database::connect();
        Database::getInstance()->connect();
        // echo "---------------------------------------------------------\n";
        // echo " \033[32m Database connection successful.\n\033[0m";
        // echo "---------------------------------------------------------\n";
        // echo "\033[41m \033[7m\033[1m ERROR!! \033[0m \033[41m Migration name is required.!! \033[0m\n";
        // echo "\033[42m \033[7m\033[1m Successfully!! \033[0m \033[45m Migration created : {$argv[1]} \033[0m\n";
    } catch (PDOException $e) {
        echo "\033[41m \033[7m\033[1m ERROR!! \033[0m \033[41m Database connection failed : " . $e->getMessage() . "\033[0m\n";
        // echo "Database connection failed: " . $e->getMessage() . "\n\n";
        exit(1);
    }
    // database/migrations/2024_09_10_181906_create_web_users_table.php
    foreach (glob(__DIR__ . '/database/migrations/*.php') as $migrationFile) {
        require_once $migrationFile;
        $class = basename($migrationFile, '.php');
        $className = preg_replace('/^[-0-9_-]+/', '', $class);
        // echo $className . "\r\n";
        $className = str_replace('-', '', trim($className, '-'));
        // echo $className . "\r\n\n\n";

        // echo $migrationFile . "\r\n\n";
        if (class_exists($className)) {
            $migration = new $className();
            $migration->up();
            // echo "\033[41m \033[7m\033[1m ERROR!! \033[0m \033[41m Migration name is required.!! \033[0m\n";
            // echo "\033[42m \033[7m\033[1m Successfully!! \033[0m \033[45m Migration created : {$argv[1]} \033[0m\n";
            // echo "---------------------------------------------------------\n";
            // echo "\033[32m\033[1m Migrated: " . $className . " \033[0m\n";
            // echo "---------------------------------------------------------\n";
        } else {
            echo "Class does not exist: " . $className . "\n";
        }
    }
}

//
function migratereset() {

    try {
        // Database::connect();
        Database::getInstance()->connect();
        // echo "Database connection successful.\n";
        // echo "---------------------------------------------------------\n";
    } catch (PDOException $e) {
        echo "Database connection failed: " . $e->getMessage() . "\n\n";
        exit(1);
    }

    // database/migrations/2024_09_10_181906_create_web_users_table.php
    foreach (glob(__DIR__ . '/database/migrations/*.php') as $migrationFile) {
        require_once $migrationFile;
        $class = basename($migrationFile, '.php');
        $className = preg_replace('/^[-0-9_-]+/', '', $class);
        // echo $className . "\r\n";
        $className = str_replace('-', '', trim($className, '-'));
        // echo $className . "\r\n\n\n";

        // echo $migrationFile . "\r\n\n";
        if (class_exists($className)) {
            $migration = new $className();
            $migration->down();
            // echo "Migrated: " . $className . "\n";
        } else {
            echo "Class does not exist: " . $className . "\n";
        }
    }
}
/*
                    echo "\033[41m \033[7m X:\Deawx> Command Not Found.!! \033[0m\n";
                            echo "\033[42m \033[7m Successfully!!\033[0m \033[45m Migration created : {$fileName} \033[0m\n";
                        } else {
                            // background yellow textred, background red text white
                            echo "\033[41m \033[7m ERROR!! \033[0m \033[41m Migration name is required.!! \033[0m\n";
                    */
function makemigration($name) {
    if ($name) {
        $timestamp = date('Y_m_d_His');
        $className = 'create_' . $name . 'table';
        $fileName = "{$timestamp}-create_{$name}-table.php";
        $migrationTemplate = <<<EOT
        <?php

        use Core\Migration;

        class {$className} {
            public function up(){
                \$migration = new Migration();
                \$migration->createTable('{$name}', function (\$table) {
                    \$table->id();

                    \$table->timestamps();
                }, 'Tables Comment Demo');
            }
            // Drop the table
            public function down(){
                    \$migration = new Migration();
                    \$migration->dropTable('{$name}');
            }
        }

            /*
                |--------------------------------------------------------------------------------------------------------------------------
                | Migration Tutorial
                | ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                |--------------------------------------------------------------------------------------------------------------------------
                |
                |     \$table->id('ID ‡∏´‡∏•‡∏±‡∏Å'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'id' ‡πÄ‡∏õ‡πá‡∏ô Primary Key ‡πÅ‡∏•‡∏∞ Auto Increment
                |     \$table->string('username', 255, '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'username' ‡∏ä‡∏ô‡∏¥‡∏î VARCHAR(255) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->string('email', 255, '‡∏≠‡∏µ‡πÄ‡∏°‡∏•'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'email' ‡∏ä‡∏ô‡∏¥‡∏î VARCHAR(255) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->string('password', 255, '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'password' ‡∏ä‡∏ô‡∏¥‡∏î VARCHAR(255) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->integer('age', '‡∏≠‡∏≤‡∏¢‡∏∏'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'age' ‡∏ä‡∏ô‡∏¥‡∏î INT ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->tinyint('status', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'status' ‡∏ä‡∏ô‡∏¥‡∏î TINYINT ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->bigint('total_points', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'total_points' ‡∏ä‡∏ô‡∏¥‡∏î BIGINT ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->text('bio', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'bio' ‡∏ä‡∏ô‡∏¥‡∏î TEXT ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->boolean('is_active', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'is_active' ‡∏ä‡∏ô‡∏¥‡∏î BOOLEAN ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->decimal('balance', 10, 2, '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'balance' ‡∏ä‡∏ô‡∏¥‡∏î DECIMAL(10,2) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->date('birthdate', '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'birthdate' ‡∏ä‡∏ô‡∏¥‡∏î DATE ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->dateTime('created_at', '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'created_at' ‡∏ä‡∏ô‡∏¥‡∏î DATETIME ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->time('login_time', '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'login_time' ‡∏ä‡∏ô‡∏¥‡∏î TIME ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->timestamp('updated_at', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'updated_at' ‡∏ä‡∏ô‡∏¥‡∏î TIMESTAMP ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->char('gender', 1, '‡πÄ‡∏û‡∏®'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'gender' ‡∏ä‡∏ô‡∏¥‡∏î CHAR(1) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->float('height', 5, 2, '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'height' ‡∏ä‡∏ô‡∏¥‡∏î FLOAT(5,2) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->double('weight', 8, 2, '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'weight' ‡∏ä‡∏ô‡∏¥‡∏î DOUBLE(8,2) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NULL
                |     \$table->unique('email'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á UNIQUE constraint ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'email'
                |     \$table->index('username'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á INDEX ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'username'
                |     \$table->timestamps(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'created_at' ‡πÅ‡∏•‡∏∞ 'updated_at' ‡∏ä‡∏ô‡∏¥‡∏î TIMESTAMP
                |     \$table->nullable('nickname', 'VARCHAR(50)'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'nickname' ‡∏ä‡∏ô‡∏¥‡∏î VARCHAR(50) ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ NULL ‡πÑ‡∏î‡πâ
                |     \$table->default('account_type', 'VARCHAR(50)', "'xxx'", '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'account_type' ‡∏ä‡∏ô‡∏¥‡∏î VARCHAR(50) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'xxx'
                |
                */
        EOT;
        file_put_contents(__DIR__ . "/database/migrations/{$fileName}", $migrationTemplate);
        echo "\033[42m \033[7m Successfully!!\033[0m \033[45m Migration created : {$fileName} \033[0m\n";
    } else {
        // background yellow textred, background red text white
        echo "\033[41m \033[7m ERROR!! \033[0m \033[41m Migration name is required.!! \033[0m\n";
    }
}

function makecontroller($name) {
    if ($name) {
        $name = ucfirst(trim($name)) . "Controller";
        $controllerTemplate = <<<EOT
<?php

namespace App\Controllers;

use Core\Json;
use Core\Cors;

class {$name}
{
    private Cors \$cors;
    private \$jsoncore;

    public function __construct() {
        \$this->cors = new Cors();
        \$this->jsoncore = new Json();
        \$this->cors->origin(['*'])
            ->methods(['GET', 'POST'])
            ->headers(['Content-Type', 'Authorization'])
            ->expose(['Content-Length'])
            ->maxAge(0)
            ->credentials(false)
            ->setHeaders();
    }

    public function index() {
        \$this->jsoncore->show([
            "status" => true,
            "message" => "üëã {$name} Controller index  EasyCore "
        ], 200);
    }
}
EOT;
        file_put_contents(__DIR__ . "/App/Controllers/{$name}.php", $controllerTemplate);
        echo "{$name} created successfully.\n";
    } else {
        echo "Controller name is required.\n";
    }
}


function makemodel($name) {
    if ($name) {
        $name = ucfirst(trim($name));
        $modelTemplate = <<<EOT
<?php

namespace App\Models;

use Exception;
use PDOException;
use Medoo\Medoo;
use Core\Database;


class {$name}
{
  private Medoo \$db;
    public function __construct() {
        \$this->db = Database::getInstance()->getConnection();
    }


}
EOT;
        file_put_contents(__DIR__ . "/App/Models/{$name}.php", $modelTemplate);
        echo "{$name} model created successfully.\n";
    } else {
        echo "Model name is required.\n";
    }
}

function dumpAutoload() {
    echo "Dumping autoload...\n";
    exec('composer dump-autoload');
    // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    echo   "\033[32m Autoload dumped successfully.\n \033[0m";
    // echo "Autoload dumped successfully.\n";
}

function serve() {
    $port = getenv('APP_PORT') ?: 8000;
    // $port = $_ENV['APP_PORT'] ?? 8000;
    $host = 'localhost';
    echo "Starting server on http://$host:$port\n";
    // exec("php -S $host:$port -t public");
    exec("php -S $host:$port");
    // echo ("php -S $host:$port");
}
